---
- name: Install software on popular distributions
  hosts: all
  become: true

  tasks:
    - name: Show detected system info
      debug:
        msg: "Detected system: {{ ansible_distribution }} (family: {{ ansible_os_family }})"

    - name: Include OS-specific variables
      include_vars: "{{ item }}"
      with_first_found:
        - "vars/{{ ansible_distribution }}.yml"
        - "vars/{{ ansible_os_family }}.yml"
        - "vars/default.yml"

    - name: Include Flatpak variables
      include_vars:
        file: vars/Flatpak.yml

    - name: Install flatpak on Fedora
      ignore_errors: true
      ansible.builtin.dnf:
        name: flatpak
        state: present
        use_backend: dnf
      when: ansible_os_family == "RedHat"

    - name: Install flatpak on Debian
      ignore_errors: true
      ansible.builtin.apt:
        name: flatpak
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install flatpak on Arch
      ignore_errors: true
      ansible.builtin.pacman:
        name: flatpak
        state: present
        update_cache: yes
      when: ansible_os_family == "Archlinux"
    
    - name: Add Flathub repository
      command: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      changed_when: false

    - name: Install Flatpak applications
      ignore_errors: true
      ansible.builtin.command:
        cmd: flatpak install -y flathub {{ item.value.name }}
      loop: "{{ flatpak_apps | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    - name: Enable DavMail COPR repository (Fedora)
      ansible.builtin.command: dnf -y copr enable mguessan/davmail
      args:
        creates: /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:mguessan:davmail.repo
      when: ansible_os_family == "RedHat"

    - name: Install packages on RedHat family using dnf
      ignore_errors: true
      ansible.builtin.dnf:
        name: "{{ item.value.name }}"
        state: present
        use_backend: dnf
      loop: "{{ software | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      when: ansible_os_family == "RedHat"

    - name: Install packages on Debian family using apt
      ignore_errors: true
      ansible.builtin.apt:
        name: "{{ item.value.name }}"
        state: present
        update_cache: yes
      loop: "{{ software | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      when: ansible_os_family == "Debian"

    - name: Install packages on Arch family using pacman
      ignore_errors: true
      ansible.builtin.pacman:
        name: "{{ item.value.name }}"
        state: present
        update_cache: yes
      loop: "{{ software | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      when: ansible_os_family == "Archlinux"

    - name: Gather the package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Show installation status using package facts
      ansible.builtin.debug:
        msg: "{{ item.key }} => {{ 'INSTALLED' if item.value.name in ansible_facts.packages else 'NOT INSTALLED' }}"
      loop: "{{ software | dict2items }}"
      loop_control:
        label: "{{ item.key }}"